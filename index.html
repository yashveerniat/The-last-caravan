<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Caravan Guardian: The Trade Route</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #dcb159; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        /* UI DESIGN */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #444; font-size: 20px; font-weight: bold;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 10;
        }
        #crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: red; transform: translate(-50%, -50%);
        }

        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* Theme Info Box */
        #theme-box {
            position: absolute; top: 20px; width: 100%; text-align: center;
            color: #8b4513; font-weight: bold; text-shadow: 1px 1px 0 #fff;
            font-size: 24px;
        }
        #sub-text { font-size: 16px; color: #555; }

        /* Health Bar */
        #health-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 400px; height: 20px; background: #333; border: 3px solid #8b4513;
            border-radius: 10px; overflow: hidden;
        }
        #health-fill { width: 100%; height: 100%; background: #00ff00; transition: 0.2s; }
        #health-label {
            position: absolute; top: -25px; left: 0; width: 100%; text-align: center;
            color: #333; font-weight: bold; text-shadow: 1px 1px 0 #fff;
        }
        
        /* Controls Hint */
        #controls-hint {
            position: absolute; bottom: 80px; width: 100%; text-align: center;
            color: #3e2723; font-weight: bold; font-size: 14px; opacity: 0.7;
        }

        /* SCREENS */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 177, 89, 0.95); display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #3e2723; z-index: 20; text-align: center;
        }
        
        h1 { font-size: 50px; margin-bottom: 10px; text-transform: uppercase; border-bottom: 4px solid #8b4513; }
        p { font-size: 18px; max-width: 600px; margin-bottom: 30px; line-height: 1.5; }
        
        button {
            padding: 15px 50px; font-size: 22px; background: #8b4513; color: #fff;
            border: 2px solid #3e2723; cursor: pointer; font-family: inherit;
            box-shadow: 5px 5px 0 #3e2723; transition: 0.1s;
        }
        button:hover { transform: translate(2px, 2px); box-shadow: 3px 3px 0 #3e2723; }

        /* TRADER INTERFACE */
        #trader-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 30; flex-direction: column;
            align-items: center; justify-content: center; color: #dcb159; pointer-events: auto;
        }
        .trader-dialogue {
            background: #3e2723; padding: 40px; border: 4px solid #dcb159; max-width: 600px; text-align: center;
        }
        .option-btn {
            display: block; width: 100%; margin: 10px 0; background: #5d4037; font-size: 18px;
        }

        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 5;
        }
    </style>
</head>
<body>

<div id="loader">LOADING TERRAIN...</div>
<div id="crosshair"></div>
<div id="damage-overlay"></div>

<div id="hud-layer">
    <div id="theme-box">
        CARAVANS & CROSSROADS<br>
        <span id="sub-text">Distance to Market: <span id="dist-display">2000</span>m</span>
    </div>
    <div id="health-container">
        <div id="health-label">CARGO INTEGRITY</div>
        <div id="health-fill"></div>
    </div>
    <div id="controls-hint">[W] BOOST | [S] BRAKE | [A/D] STEER</div>
</div>

<div id="start-screen" class="screen" style="display:none;">
    <h1>THE LAST CARAVAN</h1>
    <p><strong>Mission:</strong> Protect the cargo from desert bandits.</p>
    <p>Reach the <strong>Great Bazaar</strong> to sell your goods.</p>
    <button id="start-btn">BEGIN JOURNEY</button>
</div>

<div id="trader-screen">
    <div class="trader-dialogue">
        <h2 style="border:none;">THE GATEKEEPER</h2>
        <p id="trader-text">"Halt! You carry goods from the dunes. Before you enter the market, answer me this to prove you are a true merchant."</p>
        <div id="quiz-area">
            <button class="option-btn" onclick="checkAnswer(1)">We sell Spices and Silk.</button>
            <button class="option-btn" onclick="checkAnswer(2)">I am just a tourist.</button>
            <button class="option-btn" onclick="checkAnswer(3)">I stole this cart.</button>
        </div>
    </div>
</div>

<div id="win-screen" class="screen" style="display: none;">
    <h1 style="color: #228b22;">TRADE SUCCESSFUL</h1>
    <p>You sold the cargo for 500 Gold Coins!</p>
    <button onclick="location.reload()">NEXT CONTRACT</button>
</div>

<div id="game-over" class="screen" style="display: none;">
    <h1 style="color: #aa3333;">CARAVAN LOOTED</h1>
    <p>The bandits destroyed your cargo.</p>
    <button onclick="location.reload()">RETRY ROUTE</button>
</div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.126.0/build/three.module.js';
    import { PointerLockControls } from 'https://unpkg.com/three@0.126.0/examples/jsm/controls/PointerLockControls.js';

    // --- SETUP ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xdcb159);
    scene.fog = new THREE.FogExp2(0xdcb159, 0.015);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 3, 0); 

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // --- AUDIO ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'shoot') { 
            osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'hit') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        }
    }

    // --- GAME STATE ---
    let gameState = 'MENU'; // MENU, PLAYING, TRADING, END
    let health = 100;
    let distanceTraveled = 0;
    const totalDistance = 2000;
    
    // MOVEMENT FLAGS
    let moveForward = false;
    let moveBackward = false;
    let moveLeft = false;
    let moveRight = false;

    const enemies = [];
    const scenery = [];
    const bullets = [];

    // --- LIGHTS ---
    const sun = new THREE.DirectionalLight(0xffffff, 1.2);
    sun.position.set(-50, 100, -50);
    sun.castShadow = true;
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0xffaa66, 0.6));

    // --- GROUND ---
    const groundGeo = new THREE.PlaneGeometry(2500, 2500);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0xc2a050, roughness: 1 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // --- MARKET GATE (The End Goal) ---
    const marketGroup = new THREE.Group();
    // Big Wall
    const wall = new THREE.Mesh(new THREE.BoxGeometry(200, 40, 10), new THREE.MeshStandardMaterial({color: 0x8b4513}));
    wall.position.y = 20;
    marketGroup.add(wall);
    // Gate Hole (Black box for simplicity)
    const gate = new THREE.Mesh(new THREE.BoxGeometry(30, 30, 12), new THREE.MeshStandardMaterial({color: 0x111}));
    gate.position.y = 15;
    marketGroup.add(gate);
    
    marketGroup.position.set(0, 0, -2100); // Placed at the end
    scene.add(marketGroup);

    // --- PLAYER CART ---
    const cart = new THREE.Mesh(new THREE.BoxGeometry(4, 0.5, 6), new THREE.MeshStandardMaterial({ color: 0x8b4513 }));
    cart.position.y = -1.5;
    cart.castShadow = true;
    camera.add(cart);

    const gun = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 1.5), new THREE.MeshStandardMaterial({ color: 0x222 }));
    gun.position.set(0.5, -0.5, -1);
    camera.add(gun);

    // Horses
    const horseGroup = new THREE.Group();
    function createHorse(x) {
        const h = new THREE.Group();
        h.position.x = x;
        const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 2.5), new THREE.MeshStandardMaterial({ color: 0x5c4033 }));
        h.add(body);
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.8), new THREE.MeshStandardMaterial({ color: 0x5c4033 }));
        head.position.set(0, 0.8, -1);
        h.add(head);
        horseGroup.add(h);
    }
    createHorse(-1.5);
    createHorse(1.5);
    horseGroup.position.set(0, -2, -5);
    camera.add(horseGroup);
    
    scene.add(camera);

    // --- ENVIRONMENT ---
    function createTree(x, z) {
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.5, 3), new THREE.MeshStandardMaterial({color: 0x8b4513}));
        trunk.position.set(x, 1.5, z);
        const leaves = new THREE.Mesh(new THREE.ConeGeometry(2, 4, 8), new THREE.MeshStandardMaterial({color: 0x228b22}));
        leaves.position.y = 2;
        trunk.add(leaves);
        scene.add(trunk);
        scenery.push(trunk);
    }

    function createOasis(z) {
        const water = new THREE.Mesh(new THREE.CircleGeometry(15, 32), new THREE.MeshBasicMaterial({color: 0x00aaff}));
        water.rotation.x = -Math.PI / 2;
        water.position.set((Math.random()-0.5)*100, 0.1, z);
        if(Math.abs(water.position.x) < 20) water.position.x += 40;
        scene.add(water);
        scenery.push(water);
        for(let i=0; i<5; i++) {
            createTree(water.position.x + (Math.random()-0.5)*20, water.position.z + (Math.random()-0.5)*20);
        }
    }

    // Initial Scenery
    for(let i=0; i<60; i++) {
        createTree((Math.random()-0.5)*120, -i*20);
        if(i % 10 === 0) createOasis(-i*20);
    }

    // --- ENEMIES ---
    function spawnEnemy() {
        if(gameState !== 'PLAYING') return;
        // Don't spawn enemies if near market
        if(distanceTraveled > totalDistance - 200) return;

        const e = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.8), new THREE.MeshStandardMaterial({color: 0x8b0000}));
        body.position.y = 0.9;
        e.add(body);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshStandardMaterial({color: 0x333}));
        head.position.y = 2;
        e.add(head);

        e.position.set((Math.random()-0.5)*50, 0, camera.position.z - 80);
        e.userData = { hp: 3 };
        scene.add(e);
        enemies.push(e);
    }

    // --- CONTROLS LOGIC ---
    const controls = new PointerLockControls(camera, document.body);
    document.getElementById('loader').style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';

    document.getElementById('start-btn').addEventListener('click', () => controls.lock());
    
    controls.addEventListener('lock', () => { 
        if(gameState === 'MENU') {
            gameState = 'PLAYING';
            document.getElementById('start-screen').style.display = 'none';
        }
    });
    
    controls.addEventListener('unlock', () => {
        // Only pause if we are not in trading or end screen
        if(gameState === 'PLAYING') {
            // Optional: Pause menu
        }
    });

    const onKeyDown = function (event) {
        switch (event.code) {
            case 'KeyW': moveForward = true; break;
            case 'KeyA': moveLeft = true; break;
            case 'KeyS': moveBackward = true; break;
            case 'KeyD': moveRight = true; break;
        }
    };
    const onKeyUp = function (event) {
        switch (event.code) {
            case 'KeyW': moveForward = false; break;
            case 'KeyA': moveLeft = false; break;
            case 'KeyS': moveBackward = false; break;
            case 'KeyD': moveRight = false; break;
        }
    };
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);

    document.addEventListener('mousedown', () => {
        if(gameState !== 'PLAYING') return;
        playSound('shoot');
        
        // Recoil Effect (Reduced & Clamped)
        gun.position.z += 0.2; 
        
        // Removed the heavy camera rotation modification that was causing flipping
        // Instead, just a tiny shake
        camera.position.y += 0.05;
        setTimeout(() => camera.position.y -= 0.05, 50);

        const b = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.5), new THREE.MeshBasicMaterial({color: 0xffff00}));
        b.position.copy(camera.position);
        b.position.y -= 0.5;
        b.translateZ(-1);
        const vector = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
        b.userData = { vel: vector };
        scene.add(b);
        bullets.push(b);
    });

    setInterval(() => spawnEnemy(), 1200);

    // --- TRADER LOGIC ---
    window.checkAnswer = function(opt) {
        if(opt === 1) {
            // Correct
            document.getElementById('trader-screen').style.display = 'none';
            document.getElementById('win-screen').style.display = 'flex';
            gameState = 'END';
        } else {
            // Wrong
            document.getElementById('trader-text').innerText = "Lies! Bandits don't trade. Get out!";
            document.getElementById('trader-text').style.color = "red";
            setTimeout(() => location.reload(), 2000);
        }
    }

    function startTrading() {
        gameState = 'TRADING';
        controls.unlock(); // Unlock mouse to click buttons
        document.getElementById('trader-screen').style.display = 'flex';
    }

    // --- GAME LOOP ---
    function animate() {
        requestAnimationFrame(animate);

        const dt = 0.016;

        if(gameState === 'PLAYING') {
            // 1. MOVEMENT
            let speedZ = 12;
            if (moveForward) speedZ = 20;
            if (moveBackward) speedZ = 5;

            camera.position.z -= speedZ * dt;
            distanceTraveled += speedZ * dt;

            if (moveLeft) camera.position.x -= 15 * dt;
            if (moveRight) camera.position.x += 15 * dt;

            // Boundaries
            if (camera.position.x < -40) camera.position.x = -40;
            if (camera.position.x > 40) camera.position.x = 40;

            document.getElementById('dist-display').innerText = Math.max(0, Math.floor(totalDistance - distanceTraveled));

            // Horse Bobbing
            horseGroup.position.y = -2 + Math.sin(Date.now()*0.01)*0.2;
            gun.position.z += (-1 - gun.position.z) * 0.1;

            // REMOVED: camera.rotation.x *= 0.9; 
            // This line was causing the "tedha/ulta" issue by fighting the mouse.

            // 2. SCENERY RECYCLING (Stop recycling near market)
            scenery.forEach(obj => {
                if(obj.position.z > camera.position.z + 10 && distanceTraveled < totalDistance - 200) {
                    obj.position.z -= 200 + (Math.random()*50);
                    obj.position.x = (Math.random()-0.5)*100;
                    if(Math.abs(obj.position.x) < 15) obj.position.x += 30;
                }
            });

            // 3. WIN CONDITION check
            if(distanceTraveled >= totalDistance) {
                startTrading();
            }
        }

        // Logic that runs even if not playing (bullets flying away)
        for(let i=bullets.length-1; i>=0; i--) {
            const b = bullets[i];
            b.position.add(b.userData.vel.clone().multiplyScalar(2));
            
            let hit = false;
            for(let j=enemies.length-1; j>=0; j--) {
                const e = enemies[j];
                if(b.position.distanceTo(e.position) < 3) {
                    e.userData.hp--;
                    e.children[0].material.emissive.setHex(0xff0000);
                    setTimeout(() => { if(e) e.children[0].material.emissive.setHex(0x000000); }, 100);
                    if(e.userData.hp <= 0) {
                        scene.remove(e); enemies.splice(j, 1);
                    }
                    hit = true; break;
                }
            }
            if(hit || b.position.distanceTo(camera.position) > 100) {
                scene.remove(b); bullets.splice(i, 1);
            }
        }

        // Enemies logic
        if (gameState === 'PLAYING') {
            for(let i=enemies.length-1; i>=0; i--) {
                const e = enemies[i];
                e.lookAt(camera.position);
                e.translateZ(15 * dt);

                if(e.position.distanceTo(camera.position) < 3) {
                    health -= 15;
                    document.getElementById('health-fill').style.width = health + "%";
                    document.getElementById('damage-overlay').style.opacity = 0.8;
                    setTimeout(()=>document.getElementById('damage-overlay').style.opacity=0, 150);
                    playSound('hit');
                    scene.remove(e); enemies.splice(i, 1);
                    if(health <= 0) {
                        gameState = 'END'; controls.unlock();
                        document.getElementById('game-over').style.display = 'flex';
                    }
                }
            }
        }

        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>